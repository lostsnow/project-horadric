<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-CN" />
<meta name="Keywords" content="" />
<meta name="Description" content="" />
<title>jsonp with jquery</title>
<style type="text/css">
body {font-size:12px;}
a, a:visited {color:#234F9D;text-decoration:none;}
a:hover, a:active {color:#333;text-decoration:underline;}
.cd {margin:0 0 20px 0;}
.cd h3 {font-size:16px;width:500px;border-bottom:1px solid #ccc;padding:5px;color:#436976;}
.output {border:1px solid #436976;width:400px;padding:5px 20px;font-size:14px;}
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="FlashHelper.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $("#jsonp").click(function(){
        $.getJSON("http://www.c.com/cd/data-jsonp.php?callback=?",
        function(response){
            if(response){
                $('#cd-jsonp .output').html('output: a: ' + response.a + ', b: ' + response.b);
            } else {
                alert('error');
            }
        });
    });

    // flash & crossdomain.xml crossdomain
    $("#flash").click(function(){
        flashCall();
    });

    $("#p3p").click(function(){
        appendScript('http://www.c.com/cd/data-cookie.php?id=www.d.com');
    });

    $("#p3p-clear").click(function(){
        appendScript('http://www.c.com/cd/data-cookie.php');
    });

    // iframe cross domain by location.hash
    $("#clientform").submit(function(){
        $("#serverframe").attr('src', 'http://www.c.com/cd/iframe-a.html?'
                               + Math.floor(Math.random() * 10000) + '#'
                               + $("#bgcolor").val());
        return false;
    });
});

function appendScript(src) {
    //creat script
    var head = document.getElementsByTagName("head")[0];
    var script = document.createElement("script");
    script.setAttribute("src", src);
    script.setAttribute("type", "text/javascript");

    //after script loaded,we remove the script
    script.onload = script.onreadystatechange = function(){
        if (!this.readyState || this.readyState == "loaded" ||
            this.readyState == "complete") {
            setTimeout(function(){
                head.removeChild(script);
            }, 50);
        }
    };

    //insert script
    head.appendChild(script);
}

// flash & crossdomain.xml crossdomain
function flashCallback() {
    var response = FlashHelper.getFlash().GetVariable("retText");
    // convert to json object
    response = eval("("+response+")");
    $("#cd-flash .output").html('output: a: ' + response.a + ', b: ' + response.b);
}

function flashCall() {
    var url = 'http://www.c.com/cd/data.php';
    var method = 'get';
    var body = '';
    var contentType = 'application/x-www-form-urlencoded';

    var fs = FlashHelper.getFlash();
    fs.XmlHttp(url, "flashCallback", method, body, contentType);
}
</script>
</head>
<body>
<div id="cd-jsonp" class="cd">
<h3>1. 使用 jsonp 跨域</h3>
<a href="#" id="jsonp">获取数据</a>
<p class="output">点击获取数据</p>
</div>

<div id="cd-flash" class="cd">
<h3>2. 使用 flash & crossdomain.xml 跨域</h3>
<a href="#" id="flash">获取数据</a>
<p class="output">点击获取数据</p>
</div>

<div id="cd-iframe" class="cd">
<h3>3. 使用 iframe & url location hash 跨域</h3>
<form id="clientform">
设置 iframe 的背景色: <br />
<select id="bgcolor">
    <option value="" selected>选择颜色</option>
    <option value="white">白色</option>
    <option value="black">黑色</option>
    <option value="red">红色</option>
    <option value="green">绿色</option>
    <option value="blue">蓝色</option>
</select>
<button type="submit" id="changecolor">Go!</button>
</form>
<iframe id="serverframe" width="210" height="150" frameborder="1" src="http://www.c.com/cd/iframe-a.html#white"></iframe>
</div>

<div id="cd-p3p" class="cd">
<h3>4. 使用 P3P 跨域设置cookie</h3>
<a href="#" id="p3p">设置cookie</a>
<a href="#" id="p3p-clear">清除cookie</a>
<p class="output">点击设置cookie <br />
<a href="http://www.c.com/cd/showcookie.php" target="_blank">查看cookie</a>
</p>
</div>

<script type="text/javascript">
// flash & crossdomain.xml crossdomain
FlashHelper.writeFlash();
</script>
</body>
</html>